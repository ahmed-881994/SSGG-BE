# README

## Overview
This Python script is a serverless Lambda function designed to retrieve and format member information from a MySQL database, handle logging, and return the data in a structured JSON response. The script connects to the database, executes stored procedures, and formats the results according to the application's requirements.

## Features
- **Database Connectivity**: Establishes a connection to a MySQL database using credentials stored in environment variables.
- **Logging**: Records request and response data using a stored procedure.
- **Data Formatting**: Converts raw database records into a structured JSON format for easier consumption by clients.
- **Error Handling**: Returns appropriate HTTP status codes and messages for various scenarios, such as missing data or server errors.

## Functions
### `insert_log`
Logs request and response information into the database using the stored procedure `InsertLogs`.

**Parameters:**
- `cursor`: The database cursor.
- `event`: The API Gateway event object.
- `response`: The HTTP response generated by the Lambda function.
- `function_name`: The name of the Lambda function being logged.

### `connect`
Establishes a connection to the MySQL database using environment variables.

**Returns:**
- `conn`: The database connection object.
- `response`: An error response if the connection fails, or `None` if successful.

### `format_records`
Formats raw database records into a structured JSON object representing member details.

**Parameters:**
- `records`: The raw database records fetched by the `GetMember` stored procedure.

**Returns:**
- A JSON object with member details and associated teams.

### `lambda_handler`
The main entry point for the Lambda function. Handles the request, interacts with the database, and returns a formatted response.

**Parameters:**
- `event`: The API Gateway event object.
- `context`: The Lambda context object.

**Returns:**
- An HTTP response object.

## Environment Variables
The script requires the following environment variables to be set for database connectivity:
- `host`: The database hostname.
- `port`: The database port number.
- `database`: The database name.
- `username`: The database username.
- `password`: The database password.

## Database Stored Procedures
The script interacts with the following stored procedures:
- `InsertLogs`: Logs API request and response details.
- `GetMember`: Retrieves member details based on a `memberID`.

## Response Structure
### Success (200 OK)
```json
{
  "isBase64Encoded": false,
  "statusCode": 200,
  "headers": {
    "Content-Type": "application/json",
    "Access-Control-Allow-Headers": "*",
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "*"
  },
  "body": "{...formatted member details...}"
}
```

### Not Found (404)
```json
{
  "isBase64Encoded": false,
  "statusCode": 404,
  "headers": {
    "Content-Type": "application/json",
    "Access-Control-Allow-Headers": "*",
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "*"
  },
  "body": "{\"message\": \"Member not found\"}"
}
```

### Server Error (500)
```json
{
  "isBase64Encoded": false,
  "statusCode": 500,
  "headers": {
    "Content-Type": "application/json",
    "Access-Control-Allow-Headers": "*",
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "*"
  },
  "body": "{\"message\": \"...error details...\"}"
}
```

## Dependencies
- `datetime`: For handling date and time operations.
- `json`: For serializing and deserializing JSON data.
- `os`: For accessing environment variables.
- `pymysql`: For interacting with the MySQL database.

## Deployment
This Lambda function is deployed using GitHub workflows. The deployment process packages the source code and uploads it to AWS Lambda.

## Usage
This script is triggered by API Gateway events. Ensure the `memberID` is provided as a path parameter in the request.

## Error Handling
The script captures and logs all errors during database operations and returns an appropriate HTTP response to the client.

## Authors
- [Ahmed Safwat](https://www.github.com/ahmed-881994)